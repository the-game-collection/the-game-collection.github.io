const fs=require("fs"),{spawn:spawn}=require("child_process"),unzipper=require("unzipper");var _user,db={},platform="",tab="",_emu="";function game(s){if("emu"==s)return _emu.check();var e=s.split("_")[0],t=s.split("_")[1],i=db.list[t],a=i.dir+"\\"+decodeURIComponent(i.url).split("/").pop().slice(0,-4);db.plat_list[e].ext.some((s=>{if(fs.existsSync(a+s)&&(i.file!=a+s||i.file==a+s&&fs.statSync(a+s).size>=i.filesize))return i.iso=a+s,!0})),i.btn=i.iso?"play":"download","play"==i.btn?($("div[id='"+s+"']").parent().hide(),$("i[id='"+s+"']").html("check_box"),$("i[id='"+s+"_b']").html("play_circle_filled")):($("div[id='"+s+"']").parent().show(),$("i[id='"+s+"']").html("check_box_outline_blank"),$("i[id='"+s+"_b']").html("cloud_download")),$("span[id='"+s+"']").html(i.btn)}function myclick(s){var e=s.split("_"),t=e[0],i=db.list[e[1]];"download"==i.btn&&(i.dm?i.dm.start():i.dm=new dmaster(s,i)),"play"==i.btn&&_emu.start("xbox"==t?["-snapshot","-config_path",__dirname+"\\xemu\\xemu.toml","-dvd_path",i.iso]:[i.iso])}async function load(s,e){s&&(platform=s),e&&(tab=e);var t=await $.getJSON(`${server}/${platform}/${"#"==tab?"0":tab}.json`);db.list=[];var i=0;$("#list").html(""),t.forEach((s=>{if(s.url){var e=`<li><div class='collapsible-header' style='user-select: none;'><i id="${platform+"_"+i}" class='material-icons'></i>${s.name}<span class="badge">${s.score}</span></div><div class="collapsible-body"></div></li>`;$("#list").append(e),s.url=myurl(s.url),s.dir=__dirname+"\\downloads\\"+platform,s.file=s.dir+"\\"+decodeURIComponent(s.url).split("/").pop(),db.list.push(s),game(platform+"_"+i),i++}})),0==$("body").css("opacity")&&$("body").css({opacity:1,transition:"all 2s ease"}),(_emu=new emu).check(),Object.keys(db.plat_list).forEach((s=>{platform==s?($("#"+s).addClass("purple"),$("#"+s).removeClass("lighten-3"),$("#"+s).children("p").eq(0).css("color","white")):($("#"+s).removeClass("purple"),$("#"+s).children("p").eq(0).css("color","black"))})),$("a").each((function(){"#!"==$(this).attr("href")&&($(this).html()==tab?$(this).parent().addClass("active").removeClass("waves-effect"):$(this).parent().removeClass("active").addClass("waves-effect"))}))}function region(s){if(s.toLowerCase().split(",").some((s=>{if(["usa","europe","australia","asia","japan","korea","mexico","germany","france","russia"].indexOf(s)>-1)return!0})))return s}function langs(s){if(s.toLowerCase().split(",").some((s=>{if(["en","de","fr","es","it","jp","ru"].indexOf(s)>-1)return!0})))return s}function onOpen(s){var e=$(s).find("i").attr("id"),t=e.split("_"),i=db.list[t[1]],a=$(s).find(".collapsible-body");if(""==a.html()){var r=myname(i.name),l=r;r.slice(-9).startsWith(" (Disc ")&&(l=l.slice(0,-9));var n="",d="",o=i.file.split("\\").pop().split("(");o.length>1&&(o.shift(),o.forEach((s=>{var e=s.split(")")[0].replace(" ","");n||(n=region(e)),d||(d=langs(e))}))),filesize(i).then((s=>{i.filesize=s,a.html(`\n    <table style="table-layout: fixed;">\n      <tr class="emu_missing" style="display: none">\n        <td colspan=2>\n          <div class="alert card red lighten-4 red-text text-darken-4">\n            <div class="card-content">\n              <i class="material-icons" style="vertical-align: -6px;">report</i><span> File "${_emu.exe}" not found.<br>Please download "${_emu.name}" first</span>\n            </div>\n          </div>\n        </td>\n      </tr>\n      <tr>\n        <td style="vertical-align: top;"><img src="${server}/${t[0]}/${l}.gif" width="95%"></td>\n        <td style="vertical-align: top;">\n          <a id="${e}" onclick="myclick('${e}')" class="waves-effect waves-light btn">\n            <i id="${e}_b"class="material-icons left"></i><span id="${e}"></span>\n          </a>\n          <div class="progress"><div id="${e}" class="determinate" style="width: 0%"></div></div>\n          <p id="${e}"></p>\n          ${i.filesize>1?"<p><strong>File size:</strong> "+i.filesize+"</p>":""}\n          <p><strong>Developer:</strong> ${i.developer}</p>\n          <p><strong>Year:</strong> ${i.year}</p>\n          ${n?"<p><strong>Region:</strong> "+n+"</p>":""}\n          ${d?"<p><strong>Languages:</strong> "+d+"</p>":""}\n          <p><strong>Genres:</strong> ${i.genres}</p>\n        </td>\n      </tr>\n      <tr><td colspan="2">${i.desc}</td></tr>\n    </table>`),game(e)}))}}function filesize(s){return new Promise((e=>{if(s.filesize)e(s.filesize);else{var t=new XMLHttpRequest;t.open("GET",s.url,!0),t.setRequestHeader("Range","bytes=0-0"),t.onerror=()=>{e(0)},t.onload=()=>{200==t.status||206==t.status?e(1*t.getResponseHeader("Content-Range").split("/")[1]):e(0)},t.send(null)}}))}$(document).ready((async()=>{db=await $.getJSON(`${server}/db.json`),$(".collapsible").collapsible({onOpenStart:onOpen}),$(".brand-logo").first().html(`<img src="${server}/img/thegamecollection.png"/>`),$("#server").html(server),M.updateTextFields(),Object.keys(db.plat_list).forEach((s=>{$("#"+s).html(`<p class="center"><img class="responsive-img" src="${server}/img/${s}.png"><br>${db.plat_list[s].name}</p>`),$("#"+s).click((()=>{s!=platform&&load(s)})),$("#"+s).hover((()=>{s!=platform&&$("#"+s).addClass("purple lighten-3")})),$("#"+s).mouseleave((()=>{s!=platform&&$("#"+s).removeClass("purple lighten-3")}))})),$(".worker").hover((()=>_user.worker.stop())),$(".worker").mouseleave((()=>_user.worker.start())),$("a").click((async s=>{"#!"==$(s.target).attr("href")&&load(0,$(s.target).html()),"emu"==s.target.id&&_emu.load(),"person"==$(s.target).html()&&($("#user").is(":visible")?$("#user").hide():$("#user").show())})),_user=new user(server),load("nes","A")}));class user{usdt=0;metamask=[];market=[];megabytes=0;a=[];n=[0,"looks_one","looks_two","looks_3","looks_4","looks_5","looks_6"];constructor(s){this.server=s,this.worker=new worker,this.worker.connect(db.server[Number(s.startsWith("https:"))],(e=>{if(!1===e.login)return this.captcha("Password is wrong");if(e.demo)return this.captcha("User not found");!0===e.login&&($(".login").hide(),$("#card").show(),$("#vip").show(),$(".c_user").html($("#username").val()+`: <img src="${s}/img/USDT.png" width="20" height="20" style="vertical-align: -5px;"> <span id="USDT">0.0000</span>`)),"start"==e.gaming&&$("#vip30").addClass("red"),"stop"==e.gaming&&$("#vip30").removeClass("red"),e.downloading&&($("#vip20").addClass("red"),$("#USDT_d").html((1e-11*e.downloading).toFixed(4)));var t=!1;null!=e.usdt&&(this.usdt=e.usdt,t=!0),e.metamask&&(e.metamask.forEach((s=>{this.metamask.some(((e,t)=>{if(s.date==e.date)return this.metamask[t]=s,!0}))||this.metamask.push(s)})),t=!0),e.market&&(e.market.forEach((s=>{this.market.some(((e,t)=>{if(s.date==e.date)return s.qty+s.exec>0?this.market[t]=s:this.market.splice(t,1),!0}))||this.market.push(s)})),t=!0),t&&this.card()})),this.captcha(""),$("#login").click((()=>10*this.a[0]+this.a[1]+10*this.a[2]+this.a[3]!=$("#captcha").val()?this.captcha("Captcha is wrong"):$("#password").val().length<6?this.captcha("Password length must be at least 6 characters"):""==$("#username").val()?this.captcha("Username can not be empty"):$("#username").val().match("^[A-Za-z0-9]+$")?(this.captcha(""),void this.to_server({cmd:"login",val:"#"})):this.captcha("Username must contain only letters or digits"))),$("#vip20").click((()=>{_user.to_server({cmd:"downloading",val:"get"}),$("#USDT_d").html("0.0000")})),$("#vip30").click((()=>{_user.to_server({cmd:"gaming",val:"get"}),$("#USDT_g").html("0.0000")})),setInterval((()=>{if($("#vip30").hasClass("red")){var s=1*$("#USDT_g").html()+.01/60;$("#USDT_g").html(s.toFixed(4))}}),1e3)}card(){var s={USDT:{o:0,f:this.usdt}};this.market.forEach((e=>{"buy"==e.side&&(s.USDT.o+=e.price*(e.qty-e.exec),s.USDT.f-=e.price*e.qty),"sell"==e.side&&(s.USDT.f+=e.price*e.exec)})),this.metamask.forEach((e=>{"USDT"==e.coin&&(s.USDT.f+=1*e.qty)})),$("#USDT").html((s.USDT.o+s.USDT.f).toFixed(4)),s.USDT.o+s.USDT.f>=10?$("#vip10").html("active").addClass("green-text"):$("#vip10").html("inactive").addClass("red-text"),s.USDT.o+s.USDT.f>=20?$("#vip20").removeClass("disabled").addClass("waves-effect waves-light"):$("#vip20").removeClass("waves-effect waves-light").addClass("disabled"),s.USDT.o+s.USDT.f>=30?$("#vip30").removeClass("disabled").addClass("waves-effect waves-light"):$("#vip30").removeClass("waves-effect waves-light").addClass("disabled")}captcha(s){for(this.a=[];this.a.length<4;)this.a.push(this.random(1,6));var e="";return this.a.forEach(((s,t)=>{e+=`<i class="material-icons small">${this.n[s]}</i>`,1==t&&(e+='<i class="material-icons small">add</i>')})),$("#_captcha").html(e),""==s?($("div[id='login_error']").hide(),!0):($("span[id='login_error']").html(s),$("div[id='login_error']").show(),!1)}to_server(s){s.user=$("#username").val(),s.md5=MD5($("#password").val()),this.worker.ws_send(s)}random(s,e){return Math.floor(Math.random()*(e-s+1)+s)}}class emu{constructor(){}check(){return this.name=db.plat_list[platform].emu,this.exe=db.emu[this.name].exe,$("#emu").html(this.name),$("#exe").html(this.exe),fs.existsSync(this.exe.replace(".\\resources\\app",__dirname))?($(".td_emu").hide(),$(".emu_missing").hide(),!0):($("p[id='emu']").html(""),$("div[id='emu']").css("width","0%"),$(".td_emu").show(),!1)}load(){if(!this.check()){if(this.dm)return this.dm.start();var s=this.name+".zip",e=myurl("4#emu/"+s);this.dm=new dmaster("emu",{url:e,file:s,dir:__dirname})}}start(s){if(!this.check())return $(".emu_missing").show();_user.to_server({cmd:"gaming",val:"start"}),$("#USDT_g").html("0.0000"),spawn(this.exe.split("\\").pop(),s,{cwd:__dirname+"\\"+this.name}).on("exit",(s=>{_user.to_server({cmd:"gaming",val:"stop"})}))}}class demon{data=!1;constructor(s,e,t,i){this.id=s,this.dm=e,this.open=t,this.close=i,this.part=e.part(s);var a=new XMLHttpRequest;a.responseType="arraybuffer",a.open("GET",e.g.url,!0),a.setRequestHeader("Cache-Control","no-cache"),(1*this.id||this.part.range=="bytes=0-"+(this.dm.slot-1))&&a.setRequestHeader("Range",this.part.range),a.onload=()=>{200==a.status||206==a.status?(this.data=Buffer.from(a.response),this.dm.dir!=__dirname&&_user.to_server({cmd:"downloading",val:this.data.length}),this.trigger(),this.open()):this.dm.error()},a.onerror=()=>{this.dm.error()},a.send(null)}trigger(){if((fs.existsSync(this.dm.file)?1*fs.statSync(this.dm.file).size:0)==this.part.length&&this.data){1*this.id?fs.appendFileSync(this.dm.file,this.data,"binary"):fs.writeFileSync(this.dm.file,this.data,"binary"),this.data=!1;var s=this.dm.childs[1*this.id+1];s&&"string"!=typeof s&&s.trigger(),this.close()}else if(this.data){var e=this.dm.childs[this.id-1];e&&"string"!=typeof e&&e.trigger()}}}class dmaster{proc=0;stop=!0;slot=1e5;proc=[0,0];childs={};constructor(s,e){this.id=s,this.g=e,this.file=e.file,this.dir=e.dir,this.init(!0)}init(s){filesize(this.g).then((e=>{if(0==e)return this.error();if(this.size=e,fs.existsSync(this.file)&&fs.statSync(this.file).size==this.size)return this.proc=[1,1],void this.show();fs.existsSync(this.dir)||fs.mkdirSync(this.dir);for(var t=fs.existsSync(this.file)?fs.statSync(this.file).size:0,i=0;;){var a=this.part(i);if(0==a.size)break;t>a.length?this.proc[0]+=1:this.childs[i]=a.range,this.proc[1]+=1,i++}s?this.show()<100&&this.start():this.start(!1)}))}part(s){if(s<0)return{length:0};var e=s*this.slot,t=e+this.slot-1;return t>this.size-1&&(t=this.size-1),t<e?{size:0}:{range:"bytes="+e+"-"+t,size:t-e+1,length:e}}show(){var s=1*(100*this.proc[0]/this.proc[1]).toFixed();return $("p[id='"+this.id+"']").html(s+"%"),$("div[id='"+this.id+"']").css("width",s+"%"),this.proc[0]==this.proc[1]?(".zip"==this.file.slice(this.file.length-4).toLowerCase()?this.unzip():this.start(!1),100):s>99?99:s}async start(s){if(this.stop=0==s||!this.stop,this.stop)$("a[id='"+this.id+"']").removeClass("red"),$("#vip20").removeClass("red"),game(this.id);else{$("a[id='"+this.id+"']").addClass("red"),$("#vip20").hasClass("disabled")||dm.dir==__dirname||$("#vip20").addClass("red");for(var e=0;e<5;e++)this.child()}}async child(){if(!this.stop)for(var s=Object.keys(this.childs),e=0;e<s.length;e++){if("string"==typeof this.childs[s[e]]){this.childs[s[e]]=new demon(s[e],this,(()=>{this.child()}),(()=>{delete this.childs[s[e]],this.proc[0]+=1,this.show()}));break}}}async unzip(){if(fs.existsSync(this.file)){fs.existsSync(this.dir)||fs.mkdirSync(this.dir),$("span[id='"+this.id+"']").html("unzip");var s=fs.createReadStream(this.file).pipe(unzipper.Parse({forceStream:!0}));for await(const a of s)if("cover.gif"!=a.path&&"readme.txt"!=a.path){var e=this.dir+"\\"+a.path.replace("/","\\"),t=0,{uncompressedSize:i}=a.vars;$("p[id='"+this.id+"']").html(e),$("div[id='"+this.id+"']").css("width","0%"),"Directory"==a.type?fs.mkdirSync(e):(a.on("data",(s=>{t+=s.length,$("div[id='"+this.id+"']").css("width",(t/i*100).toFixed()+"%")})),a.pipe(fs.createWriteStream(e)))}$("p[id='"+this.id+"']").html(""),$("div[id='"+this.id+"']").css("width","0%"),this.dir==__dirname&&fs.unlinkSync(this.file),this.start(!1)}}error(){$("p[id='"+this.id+"']").html('<span style="color:red">Download error, Please try again later.</span>'),this.init(!1)}}