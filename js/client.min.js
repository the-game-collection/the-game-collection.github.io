const fs=require("fs"),{spawn:spawn}=require("child_process"),unzipper=require("unzipper");var _user,db={},platform="",tab="",_emu="";function game(e){if("emu"==e)return _emu.check();var t=e.split("_")[0],s=e.split("_")[1],i=db.list[s],r=i.dir+"\\"+decodeURIComponent(i.url).split("/").pop().slice(0,-4);db.plat_list[t].ext.some((e=>{if(fs.existsSync(r+e)&&(i.file!=r+e||i.file==r+e&&fs.statSync(r+e).size>=i.filesize))return i.iso=r+e,!0})),i.btn=i.iso?"play":"download","play"==i.btn?($("div[id='"+e+"']").parent().hide(),$("i[id='"+e+"']").html("check_box"),$("i[id='"+e+"_b']").html("play_circle_filled")):($("div[id='"+e+"']").parent().show(),$("i[id='"+e+"']").html("check_box_outline_blank"),$("i[id='"+e+"_b']").html("cloud_download")),$("span[id='"+e+"']").html(i.btn)}function myclick(e){var t=e.split("_"),s=t[0],i=db.list[t[1]];"download"==i.btn&&(i.dm?i.dm.start():i.dm=new dmaster(e,i)),"play"==i.btn&&_emu.start("xbox"==s?["-snapshot","-config_path",__dirname+"\\xemu\\xemu.toml","-dvd_path",i.iso]:[i.iso])}function myname(e){var t="";return e.toString().split("").forEach((e=>{"1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ -+(),.!_&'%".split("").indexOf(e)>-1&&(t+=e)})),t}async function load(e,t){e&&(platform=e),t&&(tab=t);var s=await $.getJSON(`${server}/${platform}/${"#"==tab?"0":tab}.json`);db.list=[];var i=0;$("#list").html(""),s.forEach((e=>{if(e.url){var t=`<li><div class='collapsible-header' style='user-select: none;'><i id="${platform+"_"+i}" class='material-icons'></i>${e.name}<span class="badge">${e.score}</span></div><div class="collapsible-body"></div></li>`;$("#list").append(t),e.url=myurl(e.url),e.dir=__dirname+"\\downloads\\"+platform,e.file=e.dir+"\\"+decodeURIComponent(e.url).split("/").pop(),db.list.push(e),game(platform+"_"+i),i++}})),0==$("body").css("opacity")&&$("body").css({opacity:1,transition:"all 2s ease"}),(_emu=new emu).check(),Object.keys(db.plat_list).forEach((e=>{platform==e?($("#"+e).addClass("purple"),$("#"+e).removeClass("lighten-3"),$("#"+e).children("p").eq(0).css("color","white")):($("#"+e).removeClass("purple"),$("#"+e).children("p").eq(0).css("color","black"))})),$("a").each((function(){"#!"==$(this).attr("href")&&($(this).html()==tab?$(this).parent().addClass("active").removeClass("waves-effect"):$(this).parent().removeClass("active").addClass("waves-effect"))}))}function region(e){if(e.toLowerCase().split(",").some((e=>{if(["usa","europe","australia","asia","japan","korea","mexico","germany","france","russia"].indexOf(e)>-1)return!0})))return e}function langs(e){if(e.toLowerCase().split(",").some((e=>{if(["en","de","fr","es","it","jp","ru"].indexOf(e)>-1)return!0})))return e}function onOpen(e){var t=$(e).find("i").attr("id"),s=t.split("_"),i=db.list[s[1]],r=$(e).find(".collapsible-body");if(""==r.html()){var a=myname(i.name),n=a;a.slice(-9).startsWith(" (Disc ")&&(n=n.slice(0,-9));var l="",o="",d=i.file.split("\\").pop().split("(");d.length>1&&(d.shift(),d.forEach((e=>{var t=e.split(")")[0].replace(" ","");l||(l=region(t)),o||(o=langs(t))}))),filesize(i).then((e=>{i.filesize=e,r.html(`\n    <table style="table-layout: fixed;">\n      <tr class="emu_missing" style="display: none">\n        <td colspan=2>\n          <div class="alert card red lighten-4 red-text text-darken-4">\n            <div class="card-content">\n              <i class="material-icons" style="vertical-align: -6px;">report</i><span> File "${_emu.exe}" not found.<br>Please download "${_emu.name}" first</span>\n            </div>\n          </div>\n        </td>\n      </tr>\n      <tr>\n        <td style="vertical-align: top;"><img src="${server}/${s[0]}/${n}.gif" width="95%"></td>\n        <td style="vertical-align: top;">\n          <a id="${t}" onclick="myclick('${t}')" class="waves-effect waves-light btn">\n            <i id="${t}_b"class="material-icons left"></i><span id="${t}"></span>\n          </a>\n          <div class="progress"><div id="${t}" class="determinate" style="width: 0%"></div></div>\n          <p id="${t}"></p>\n          ${i.filesize>1?"<p><strong>File size:</strong> "+i.filesize+"</p>":""}\n          <p><strong>Developer:</strong> ${i.developer}</p>\n          <p><strong>Year:</strong> ${i.year}</p>\n          ${l?"<p><strong>Region:</strong> "+l+"</p>":""}\n          ${o?"<p><strong>Languages:</strong> "+o+"</p>":""}\n          <p><strong>Genres:</strong> ${i.genres}</p>\n        </td>\n      </tr>\n      <tr><td colspan="2">${i.desc}</td></tr>\n    </table>`),game(t)}))}}function myurl(e){for(const[t,s]of Object.entries(db.prefixes))if(e.startsWith(t+"#")){e=s+e.slice(t.length+1);break}return e.startsWith("http")?e:"https://archive.org/download/"+e}function filesize(e){return new Promise((t=>{if(e.filesize)t(e.filesize);else{var s=new XMLHttpRequest;s.open("GET",e.url,!0),s.setRequestHeader("Range","bytes=0-0"),s.onerror=()=>{t(0)},s.onload=()=>{200==s.status||206==s.status?t(1*s.getResponseHeader("Content-Range").split("/")[1]):t(0)},s.send(null)}}))}function check_num(e){var t=e.which?e.which:e.keyCode;return 46==t||t>47&&t<58}$(document).ready((async()=>{db=await $.getJSON(`${server}/db.json`),$(".collapsible").collapsible({onOpenStart:onOpen}),$(".brand-logo").first().html(`<img src="${server}/img/thegamecollection.png"/>`),$("#server").html(server),$("#USDT_i").html(`<img src="${server}/img/USDT.png" width="32" height="32" style="vertical-align: -10px;">&nbsp;&nbsp;USDT`),M.updateTextFields(),Object.keys(db.plat_list).forEach((e=>{$("#"+e).html(`<p class="center"><img class="responsive-img" src="${server}/img/${e}.png"><br>${db.plat_list[e].name}</p>`),$("#"+e).click((()=>{e!=platform&&load(e)})),$("#"+e).hover((()=>{e!=platform&&$("#"+e).addClass("purple lighten-3")})),$("#"+e).mouseleave((()=>{e!=platform&&$("#"+e).removeClass("purple lighten-3")}))})),$(".worker").hover((()=>_user.worker.stop())),$(".worker").mouseleave((()=>_user.worker.start())),$("a").click((async e=>{"#!"==$(e.target).attr("href")&&load(0,$(e.target).html()),"emu"==e.target.id&&_emu.load(),"person"==$(e.target).html()&&($("#user").is(":visible")?$("#user").hide():$("#user").show())})),_user=new user(server),load("nes","A")}));class user{usdt=0;metamask=[];market=[];megabytes=0;a=[];n=[0,"looks_one","looks_two","looks_3","looks_4","looks_5","looks_6"];constructor(e){this.server=e,this.worker=new worker,this.worker.connect(db.server[Number(e.startsWith("https:"))],(e=>{if(!1===e.login)return this.captcha("Password is wrong");if(e.demo)return this.captcha("User not found");!0===e.login&&($(".login").hide(),$("#card").show(),$("#vip").show(),$(".c_user").html($("#username").val())),"start"==e.gaming&&$("#vip30").addClass("red"),"stop"==e.gaming&&$("#vip30").removeClass("red"),e.downloading&&($("#vip20").addClass("red"),$("#USDT_d").html((1e-11*e.downloading).toFixed(4)));var t=!1;null!=e.usdt&&(this.usdt=e.usdt,t=!0),e.metamask&&(e.metamask.forEach((e=>{this.metamask.some(((t,s)=>{if(e.date==t.date)return this.metamask[s]=e,!0}))||this.metamask.push(e)})),t=!0),e.market&&(e.market.forEach((e=>{this.market.some(((t,s)=>{if(e.date==t.date)return e.qty+e.exec>0?this.market[s]=e:this.market.splice(s,1),!0}))||this.market.push(e)})),t=!0),t&&this.card()})),this.captcha(""),$("#login").click((()=>10*this.a[0]+this.a[1]+10*this.a[2]+this.a[3]!=$("#captcha").val()?this.captcha("Captcha is wrong"):$("#password").val().length<6?this.captcha("Password length must be at least 6 characters"):""==$("#username").val()?this.captcha("Username can not be empty"):$("#username").val().match("^[A-Za-z0-9]+$")?(this.captcha(""),void this.to_server({cmd:"login",val:"#"})):this.captcha("Username must contain only letters or digits"))),$("#vip20").click((()=>{_user.to_server({cmd:"downloading",val:"get"}),$("#USDT_d").html("0.0000")})),$("#vip30").click((()=>{_user.to_server({cmd:"gaming",val:"get"}),$("#USDT_g").html("0.0000")})),setInterval((()=>{if($("#vip30").hasClass("red")){var e=1*$("#USDT_g").html()+.01/60;$("#USDT_g").html(e.toFixed(4))}}),1e3)}card(){var e={USDT:{o:0,f:this.usdt}};return this.market.forEach((t=>{"buy"==t.side&&(e.USDT.o+=t.price*(t.qty-t.exec),e.USDT.f-=t.price*t.qty),"sell"==t.side&&(e.USDT.f+=t.price*t.exec)})),this.metamask.forEach((t=>{"USDT"==t.coin&&(e.USDT.f+=1*t.qty)})),$("#USDT_o").html(1*e.USDT.o.toFixed(4)),$("#USDT_f").html(1*e.USDT.f.toFixed(4)),e.USDT.f>=10?$("#vip10").html("active").addClass("green-text"):$("#vip10").html("inactive").addClass("red-text"),e.USDT.f>=20?$("#vip20").removeClass("disabled").addClass("waves-effect waves-light"):$("#vip20").removeClass("waves-effect waves-light").addClass("disabled"),e.USDT.f>=30?$("#vip30").removeClass("disabled").addClass("waves-effect waves-light"):$("#vip30").removeClass("waves-effect waves-light").addClass("disabled"),e}captcha(e){for(this.a=[];this.a.length<4;)this.a.push(this.random(1,6));var t="";return this.a.forEach(((e,s)=>{t+=`<i class="material-icons small">${this.n[e]}</i>`,1==s&&(t+='<i class="material-icons small">add</i>')})),$("#_captcha").html(t),""==e?($("div[id='login_error']").hide(),!0):($("span[id='login_error']").html(e),$("div[id='login_error']").show(),!1)}to_server(e){e.user=$("#username").val(),e.md5=MD5($("#password").val()),this.worker.ws_send(e)}random(e,t){return Math.floor(Math.random()*(t-e+1)+e)}}class emu{constructor(){}check(){return this.name=db.plat_list[platform].emu,this.exe=db.emu[this.name].exe,$("#emu").html(this.name),$("#exe").html(this.exe),fs.existsSync(this.exe.replace(".\\resources\\app",__dirname))?($(".td_emu").hide(),$(".emu_missing").hide(),!0):($("p[id='emu']").html(""),$("div[id='emu']").css("width","0%"),$(".td_emu").show(),!1)}load(){if(!this.check()){if(this.dm)return this.dm.start();var e=this.name+".zip",t=myurl("4#emu/"+e);this.dm=new dmaster("emu",{url:t,file:e,dir:__dirname})}}start(e){if(!this.check())return $(".emu_missing").show();$("#vip30").hasClass("disabled")||_user.to_server({cmd:"gaming",val:"start"}),$("#USDT_g").html(0),spawn(this.exe.split("\\").pop(),e,{cwd:__dirname+"\\"+this.name}).on("exit",(e=>{$("#vip30").hasClass("disabled")||_user.to_server({cmd:"gaming",val:"stop"})}))}}class demon{data=!1;constructor(e,t,s,i){this.id=e,this.dm=t,this.open=s,this.close=i,this.part=t.part(e);var r=new XMLHttpRequest;r.responseType="arraybuffer",r.open("GET",t.g.url,!0),r.setRequestHeader("Cache-Control","no-cache"),(1*this.id||this.part.range=="bytes=0-"+(this.dm.slot-1))&&r.setRequestHeader("Range",this.part.range),r.onload=()=>{200==r.status||206==r.status?(this.data=Buffer.from(r.response),$("#vip20").hasClass("red")&&_user.to_server({cmd:"downloading",val:this.data.length}),this.trigger(),this.open()):this.dm.error()},r.onerror=()=>{this.dm.error()},r.send(null)}trigger(){if((fs.existsSync(this.dm.file)?1*fs.statSync(this.dm.file).size:0)==this.part.length&&this.data){1*this.id?fs.appendFileSync(this.dm.file,this.data,"binary"):fs.writeFileSync(this.dm.file,this.data,"binary"),this.data=!1;var e=this.dm.childs[1*this.id+1];e&&"string"!=typeof e&&e.trigger(),this.close()}else if(this.data){var t=this.dm.childs[this.id-1];t&&"string"!=typeof t&&t.trigger()}}}class dmaster{proc=0;stop=!0;slot=1e5;proc=[0,0];childs={};constructor(e,t){this.id=e,this.g=t,this.file=t.file,this.dir=t.dir,this.init(!0)}init(e){filesize(this.g).then((t=>{if(0==t)return this.error();if(this.size=t,fs.existsSync(this.file)&&fs.statSync(this.file).size==this.size)return this.proc=[1,1],void this.show();fs.existsSync(this.dir)||fs.mkdirSync(this.dir);for(var s=fs.existsSync(this.file)?fs.statSync(this.file).size:0,i=0;;){var r=this.part(i);if(0==r.size)break;s>r.length?this.proc[0]+=1:this.childs[i]=r.range,this.proc[1]+=1,i++}e?this.show()<100&&this.start():this.start(!1)}))}part(e){if(e<0)return{length:0};var t=e*this.slot,s=t+this.slot-1;return s>this.size-1&&(s=this.size-1),s<t?{size:0}:{range:"bytes="+t+"-"+s,size:s-t+1,length:t}}show(){var e=1*(100*this.proc[0]/this.proc[1]).toFixed();return $("p[id='"+this.id+"']").html(e+"%"),$("div[id='"+this.id+"']").css("width",e+"%"),this.proc[0]==this.proc[1]?(".zip"==this.file.slice(this.file.length-4).toLowerCase()?this.unzip():this.start(!1),100):e>99?99:e}async start(e){if(this.stop=0==e||!this.stop,this.stop)$("a[id='"+this.id+"']").removeClass("red"),$("#vip20").removeClass("red"),game(this.id);else{$("a[id='"+this.id+"']").addClass("red"),$("#vip20").hasClass("disabled")||dm.dir==__dirname||$("#vip20").addClass("red");for(var t=0;t<5;t++)this.child()}}async child(){if(!this.stop)for(var e=Object.keys(this.childs),t=0;t<e.length;t++){if("string"==typeof this.childs[e[t]]){this.childs[e[t]]=new demon(e[t],this,(()=>{this.child()}),(()=>{delete this.childs[e[t]],this.proc[0]+=1,this.show()}));break}}}async unzip(){if(fs.existsSync(this.file)){fs.existsSync(this.dir)||fs.mkdirSync(this.dir),$("span[id='"+this.id+"']").html("unzip");var e=fs.createReadStream(this.file).pipe(unzipper.Parse({forceStream:!0}));for await(const r of e)if("cover.gif"!=r.path&&"readme.txt"!=r.path){var t=this.dir+"\\"+r.path.replace("/","\\"),s=0,{uncompressedSize:i}=r.vars;$("p[id='"+this.id+"']").html(t),$("div[id='"+this.id+"']").css("width","0%"),"Directory"==r.type?fs.mkdirSync(t):(r.on("data",(e=>{s+=e.length,$("div[id='"+this.id+"']").css("width",(s/i*100).toFixed()+"%")})),r.pipe(fs.createWriteStream(t)))}$("p[id='"+this.id+"']").html(""),$("div[id='"+this.id+"']").css("width","0%"),this.dir==__dirname&&fs.unlinkSync(this.file),this.start(!1)}}error(){$("p[id='"+this.id+"']").html('<span style="color:red">Download error, Please try again later.</span>'),this.init(!1)}}function MD5(e){function t(e,t,s,i,r,a){return n(function(e,t){return e<<t|e>>>32-t}(n(n(t,e),n(i,a)),r),s)}function s(e,s,i,r,a,n,l){return t(s&i|~s&r,e,s,a,n,l)}function i(e,s,i,r,a,n,l){return t(s&r|i&~r,e,s,a,n,l)}function r(e,s,i,r,a,n,l){return t(s^i^r,e,s,a,n,l)}function a(e,s,i,r,a,n,l){return t(i^(s|~r),e,s,a,n,l)}function n(e,t){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}var l=function(e){for(var t,s="0123456789ABCDEF",i="",r=0;r<e.length;r++)t=e.charCodeAt(r),i+=s.charAt(t>>>4&15)+s.charAt(15&t);return i}(function(e){for(var t="",s=0;s<32*e.length;s+=8)t+=String.fromCharCode(e[s>>5]>>>s%32&255);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var l=1732584193,o=-271733879,d=-1732584194,h=271733878,c=0;c<e.length;c+=16){var p=l,m=o,f=d,u=h;o=a(o=a(o=a(o=a(o=r(o=r(o=r(o=r(o=i(o=i(o=i(o=i(o=s(o=s(o=s(o=s(o,d=s(d,h=s(h,l=s(l,o,d,h,e[c+0],7,-680876936),o,d,e[c+1],12,-389564586),l,o,e[c+2],17,606105819),h,l,e[c+3],22,-1044525330),d=s(d,h=s(h,l=s(l,o,d,h,e[c+4],7,-176418897),o,d,e[c+5],12,1200080426),l,o,e[c+6],17,-1473231341),h,l,e[c+7],22,-45705983),d=s(d,h=s(h,l=s(l,o,d,h,e[c+8],7,1770035416),o,d,e[c+9],12,-1958414417),l,o,e[c+10],17,-42063),h,l,e[c+11],22,-1990404162),d=s(d,h=s(h,l=s(l,o,d,h,e[c+12],7,1804603682),o,d,e[c+13],12,-40341101),l,o,e[c+14],17,-1502002290),h,l,e[c+15],22,1236535329),d=i(d,h=i(h,l=i(l,o,d,h,e[c+1],5,-165796510),o,d,e[c+6],9,-1069501632),l,o,e[c+11],14,643717713),h,l,e[c+0],20,-373897302),d=i(d,h=i(h,l=i(l,o,d,h,e[c+5],5,-701558691),o,d,e[c+10],9,38016083),l,o,e[c+15],14,-660478335),h,l,e[c+4],20,-405537848),d=i(d,h=i(h,l=i(l,o,d,h,e[c+9],5,568446438),o,d,e[c+14],9,-1019803690),l,o,e[c+3],14,-187363961),h,l,e[c+8],20,1163531501),d=i(d,h=i(h,l=i(l,o,d,h,e[c+13],5,-1444681467),o,d,e[c+2],9,-51403784),l,o,e[c+7],14,1735328473),h,l,e[c+12],20,-1926607734),d=r(d,h=r(h,l=r(l,o,d,h,e[c+5],4,-378558),o,d,e[c+8],11,-2022574463),l,o,e[c+11],16,1839030562),h,l,e[c+14],23,-35309556),d=r(d,h=r(h,l=r(l,o,d,h,e[c+1],4,-1530992060),o,d,e[c+4],11,1272893353),l,o,e[c+7],16,-155497632),h,l,e[c+10],23,-1094730640),d=r(d,h=r(h,l=r(l,o,d,h,e[c+13],4,681279174),o,d,e[c+0],11,-358537222),l,o,e[c+3],16,-722521979),h,l,e[c+6],23,76029189),d=r(d,h=r(h,l=r(l,o,d,h,e[c+9],4,-640364487),o,d,e[c+12],11,-421815835),l,o,e[c+15],16,530742520),h,l,e[c+2],23,-995338651),d=a(d,h=a(h,l=a(l,o,d,h,e[c+0],6,-198630844),o,d,e[c+7],10,1126891415),l,o,e[c+14],15,-1416354905),h,l,e[c+5],21,-57434055),d=a(d,h=a(h,l=a(l,o,d,h,e[c+12],6,1700485571),o,d,e[c+3],10,-1894986606),l,o,e[c+10],15,-1051523),h,l,e[c+1],21,-2054922799),d=a(d,h=a(h,l=a(l,o,d,h,e[c+8],6,1873313359),o,d,e[c+15],10,-30611744),l,o,e[c+6],15,-1560198380),h,l,e[c+13],21,1309151649),d=a(d,h=a(h,l=a(l,o,d,h,e[c+4],6,-145523070),o,d,e[c+11],10,-1120210379),l,o,e[c+2],15,718787259),h,l,e[c+9],21,-343485551),l=n(l,p),o=n(o,m),d=n(d,f),h=n(h,u)}return Array(l,o,d,h)}(function(e){for(var t=Array(e.length>>2),s=0;s<t.length;s++)t[s]=0;for(s=0;s<8*e.length;s+=8)t[s>>5]|=(255&e.charCodeAt(s/8))<<s%32;return t}(e),8*e.length)));return l.toLowerCase()}